{% extends "base.html" %}

{% block title %}AI Assistant - Educational Platform{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2 class="mb-4">AI Assistant</h2>
    
    <div class="card">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0">Chat with AI Assistant</h5>
        </div>
        <div class="card-body">
            <div id="chat-messages" class="mb-3" style="height: 400px; overflow-y: auto; border: 1px solid #ddd; padding: 15px; border-radius: 5px;">
                <div class="alert alert-info">
                    <strong>AI Assistant:</strong> Hello! I'm your AI assistant. I can help answer questions based on the documents in our system.
                    Ask me anything about the course materials!
                </div>
            </div>
            
            <div class="input-group">
                <input type="text" id="user-input" class="form-control" placeholder="Type your question here..." onkeypress="if(event.keyCode === 13) sendMessage()">
                <div class="input-group-append">
                    <button class="btn btn-primary" type="button" onclick="sendMessage()">
                        <i class="fas fa-paper-plane"></i> Send
                    </button>
                </div>
            </div>
            <small class="form-text text-muted">
                The AI will reference uploaded documents when answering your questions.
            </small>
        </div>
    </div>
</div>

<script>
function addMessage(sender, message) {
    const chatMessages = document.getElementById('chat-messages');
    const messageDiv = document.createElement('div');
    messageDiv.className = `alert ${sender === 'user' ? 'alert-secondary' : 'alert-info'}`;
    messageDiv.innerHTML = `<strong>${sender === 'user' ? 'You' : 'AI Assistant'}:</strong> ${message}`;
    chatMessages.appendChild(messageDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

async function sendMessage() {
    const input = document.getElementById('user-input');
    const message = input.value.trim();
    
    if (!message) return;
    
    // Add user message to chat
    addMessage('user', message);
    input.value = '';
    
    try {
        // Show typing indicator
        const typingIndicator = document.createElement('div');
        typingIndicator.id = 'typing-indicator';
        typingIndicator.className = 'alert alert-light';
        typingIndicator.innerHTML = '<em>AI is thinking...</em>';
        document.getElementById('chat-messages').appendChild(typingIndicator);
        
        // Send message to server
        const response = await fetch('/api/chat', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ message: message })
        });
        
        // Remove typing indicator
        document.getElementById('chat-messages').removeChild(typingIndicator);
        
        const data = await response.json();
        
        if (response.ok) {
            addMessage('ai', data.response);
        } else {
            addMessage('ai', `Error: ${data.error || 'Something went wrong'}`);
        }
    } catch (error) {
        if (document.getElementById('typing-indicator')) {
            document.getElementById('chat-messages').removeChild(typingIndicator);
        }
        addMessage('ai', 'Error: Could not connect to the server');
        console.error('Error:', error);
    }
}

// Allow sending message with Enter key
document.getElementById('user-input').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        sendMessage();
    }
});
</script>

<style>
#chat-messages {
    background-color: #f9f9f9;
    border-radius: 5px;
    padding: 15px;
    margin-bottom: 15px;
}

.alert {
    margin-bottom: 10px;
    word-wrap: break-word;
}

.alert:last-child {
    margin-bottom: 0;
}

#user-input {
    border-top-right-radius: 0;
    border-bottom-right-radius: 0;
}

.btn-send {
    border-top-left-radius: 0;
    border-bottom-left-radius: 0;
}
</style>
{% endblock %}
